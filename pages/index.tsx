import type { NextPage } from 'next'
import Head from 'next/head'
import { useRouter } from 'next/router';
import { useContext, useEffect, useState } from 'react';
import { ProductRecommendationContext } from '../Context/ProductRecommendationContext';
import axios from 'axios';
import SlideShow from '../Components/SlideShow';
import { SyncLoader } from 'react-spinners';

const Home: NextPage = () => {
  const router = useRouter();
  const [recLoading, setRecLoading] = useState(false);
  const [fetchMessage, setFetchMessage] = useState("");

  const { user,
          personalisedProducts,
          setPersonalisedProducts,
          topProducts,
          setTopProducts,
          similarProducts,
          setSimilarProducts
          }: any = useContext(ProductRecommendationContext);

  const userId = user;

  const getRecommendations = async() => {
    setRecLoading(true)
    try {
      setFetchMessage("Generating Personlised Products...")
      const personalisedProductsFetch = await axios.get(`http://127.0.0.1:5000/api/recommended-products/${userId}`);
      setPersonalisedProducts(personalisedProductsFetch.data);

      setFetchMessage("Genrating Top Prodcuts...")
      const topProductFetch = await axios.get(`http://127.0.0.1:5000/api//top-products/${userId}`);
      setTopProducts(topProductFetch.data);

      setFetchMessage("Generating Similar User Products...")
      const similarProductsFetch = await axios.get(`http://127.0.0.1:5000/api/similar-products/${userId}`)
      setSimilarProducts(similarProductsFetch.data);

    } catch (error) {
      console.error('Error fetching recommended products:', error);
    }
    setRecLoading(false)
  }

  console.log("Personalised Products : ")
  console.log(personalisedProducts)

  console.log("Top Products: ")
  console.log(topProducts)

  console.log("Similar User Products: ");
  console.log(similarProducts);

  return (
    <div className='m-2 p-3'>
      <Head>
        <title>ProductRecommendation</title>
        <meta name="Personalized Product Recommendation System" content="Generated by create next app" />
      </Head>

      {
        !(similarProducts && personalisedProducts && topProducts) ?

        <div className='flex flex-col items-center justify-center bg-neutral-100 rounded-xl p-5'>
          {
            recLoading ?
            <div className='felx flex-col justify-center text-center'>
              <SyncLoader color="rgb(14 165 233)" size={20} />
              <div className='items-center flex space-x-2 m-3 bg-neutral-200 p-2 px-10 rounded-xl mt-4'>
                <h1 className='animate-spin'>+</h1>
                <h1 className='font-semibold '>{fetchMessage}</h1>
              </div>
            </div>
            :
            <button onClick={getRecommendations} className='text-center font-semibold bg-sky-500 p-2 rounded-xl px-5 text-white hover:shadow-lg active:bg-sky-600'>Get Recommendations</button>
          }
        </div>

        :

        <div className='rounded-xl flex flex-col'>
          <div className='bg-neutral-700 rounded-xl p-2'>
            <h1 className='font-bold text-center text-lg text-neutral-400'>RECOMMENDATIONS</h1>
          </div>
          <div className='flex space-x-2 mt-2'>

            <div onClick={() => router.push("/personalizedproducts")} className='bg-neutral-100 rounded-xl w-1/3 p-3 cursor-pointer hover:shadow-lg'>
              <h1 className='text-center font-semibold mb-3'>Personalized Products</h1>

              <div className="grid grid-cols-2 gap-4">
                  <div>
                      <img className="h-auto max-w-full rounded-lg" src="https://flowbite.s3.amazonaws.com/docs/gallery/square/image.jpg" alt="" />
                  </div>
                  <div>
                      <img className="h-auto max-w-full rounded-lg" src="https://flowbite.s3.amazonaws.com/docs/gallery/square/image-1.jpg" alt="" />
                  </div>
                  <div>
                      <img className="h-auto max-w-full rounded-lg" src="https://flowbite.s3.amazonaws.com/docs/gallery/square/image-2.jpg" alt="" />
                  </div>
                  <div>
                      <img className="h-auto max-w-full rounded-lg" src="https://flowbite.s3.amazonaws.com/docs/gallery/square/image-3.jpg" alt="" />
                  </div>
              </div>

            </div>


            <div onClick={() => router.push('/topproducts')} className='bg-neutral-100 rounded-xl w-1/3 p-3 cursor-pointer hover:shadow-lg'>
              <h1 className='text-center font-semibold mb-3'>Top Products</h1>
              
              <div className="grid grid-cols-2 gap-4">
                  <div>
                      <img className="h-auto max-w-full rounded-lg" src="https://flowbite.s3.amazonaws.com/docs/gallery/square/image.jpg" alt="" />
                  </div>
                  <div>
                      <img className="h-auto max-w-full rounded-lg" src="https://flowbite.s3.amazonaws.com/docs/gallery/square/image-1.jpg" alt="" />
                  </div>
                  <div>
                      <img className="h-auto max-w-full rounded-lg" src="https://flowbite.s3.amazonaws.com/docs/gallery/square/image-2.jpg" alt="" />
                  </div>
                  <div>
                      <img className="h-auto max-w-full rounded-lg" src="https://flowbite.s3.amazonaws.com/docs/gallery/square/image-3.jpg" alt="" />
                  </div>
              </div>

            </div>


            <div onClick={() => router.push('/similaruserproducts')} className='bg-neutral-100 rounded-xl w-1/3 p-3 cursor-pointer hover:shadow-lg'>
              <h1 className='text-center font-semibold mb-3'>Based On Similar Users</h1>

              <div className="grid grid-cols-2 gap-4">
                  <div>
                      <img className="h-auto max-w-full rounded-lg" src="https://flowbite.s3.amazonaws.com/docs/gallery/square/image.jpg" alt="" />
                  </div>
                  <div>
                      <img className="h-auto max-w-full rounded-lg" src="https://flowbite.s3.amazonaws.com/docs/gallery/square/image-1.jpg" alt="" />
                  </div>
                  <div>
                      <img className="h-auto max-w-full rounded-lg" src="https://flowbite.s3.amazonaws.com/docs/gallery/square/image-2.jpg" alt="" />
                  </div>
                  <div>
                      <img className="h-auto max-w-full rounded-lg" src="https://flowbite.s3.amazonaws.com/docs/gallery/square/image-3.jpg" alt="" />
                  </div>
              </div>

            </div>
          </div>

        </div>
      }

    </div>
  )
}

export default Home;
